<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POS Screen</title>
    <link rel="stylesheet" href="bootstrap.css" />
    <link rel="stylesheet" href="Sweetalert.css" />
    <link rel="stylesheet" href="Style.css">
  </head>
  <body class="p-4">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-8">
          <div class="row" id="main_product_card"></div>
        </div>

        <div class="col-md-4 table-card p-0">
          <div class="table-responsive invoice-box">
            <h5 class="font-weight-bold text-center">Products Selected</h5>
            <table class="table table-bordered text-center">
              <thead class="text-white bg-dark rounded">
                <tr >
                  <th class="rounded">No.</th>
                  <th class="rounded">Name</th>
                  <th class="rounded">Quantity</th>
                  <th class="rounded">Price</th>
                  <th class="rounded">Total</th>
                  <th class="rounded">Action</th>
                </tr>
              </thead>
              <tbody id="selected_table_tr"></tbody>
            </table>

            <table class="table table-bordered text-center font-weight-bold">
              <tr>
                <th>
                  <h3 class="font-weight-bold">Total</h3>
                </th>
                <th  style="text-align: right;">
                  <h3 class="font-weight-bold" id="total_usd">($): 0</h3>
                  <h3 class="font-weight-bold" id="total_khr">(៛): 0</h3>
                </th>
              </tr>
            </table>
          <!-- received -->
            <table class="table table-bordered text-center bg-warning text-white">
              <tr>
                <th style="border-color: #000">
                  <h3 class="font-weight-bold">Received</h3>
                </th>
                <th class="label" style="border-color: #000 ; ">
                  <input 
                    type="number"
                    class="form-control  "
                    id="received_amount"
                    placeholder="Please enter amount received"
                    onkeyup="getChangeaMount()"
                  />                </th>
              </tr>
            </table>

            <!-- Change -->

            <table class="table table-bordered text-center">
              <tr class="bg-warning text-white">
                <th id="change_tr" style="display: none">
                  <h3 class="font-weight-bold ">Change</h3>
                </th>
                <th class="label2" id="change_input_th" style="display: none">
                  <input
                    type="number"
                    class="form-control"
                    id="Change_Amount"
                    placeholder="0"
                  />
                </th>
              </tr>
            </table>
            <table class="table table-bordered text-left">
              <tr>
                <th>
                  <input
                    style="height: 100px; width: 120px; font-size: 20px; font-weight: bold;"
                    onclick="Cancel()"
                    type="button"
                    class="btn btn-danger"
                    id="btn_Cancel"
                    value="Cancel "
                  />
                </th>
                <th>
                  <input
               
                    style="height: 100px; width: 100px; font-size: 50px"
                    type="button"
                    class="btn btn-primary w-100"
                    id="btn_Pay_Now"
                    value="Pay Now"
                  />
                </th>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    let products_List = JSON.parse(
      localStorage.getItem("product_list") ?? "[]"
    );
    let selected_product = [];
    let main_product_card = document.getElementById("main_product_card");
    let selected_table_tr = document.getElementById("selected_table_tr");
    let btn_Pay_Now = document.getElementById("btn_Pay_Now");
    let total = 0;
    let input_received_amount = document.getElementById("received_amount");
    let change_amount = 0;
    renderProductCard();

    function renderselectedproduct() {
      let selected_product_tr_html = "";
      selected_product.forEach((product, index) => {
        let totalRow = product.value_price * product.value_quantity;
        selected_product_tr_html += `<tr>
          <td>${index + 1}</td>
          <td>${product.value_name}</td>
          <td>${product.value_quantity}</td>
          <td>${product.value_price} $</td>
          <td>${totalRow}</td>
          <td>
            <button onclick="removeItem(${index})" class="btn btn-danger btn-sm">Delete</button>
          </td>
        </tr>`;
      });
      selected_table_tr.innerHTML = selected_product_tr_html;
    }
    function renderProductCard() {
      let html_card = "";
      products_List.forEach((product, index) => {
        html_card += `<div class="col-md-3" onclick="cartOnClick(${index})">
        <div class="card" style="width: 100%">
          <img src="${product.value_imageURL}" class="card-img-top" />
          <div class="card-body">
            <h5 class="card-title">${product.value_name}</h5>
            <p class="card-text">${product.value_price} $</p>
          </div>
        </div>
      </div>`;
      });
      main_product_card.innerHTML = html_card;
    }

    function cartOnClick(index) {
      let current_product = { ...products_List[index] };
      let dpl_product = null;

      for (let i = 0; i < selected_product.length; i++) {
        if (current_product.value_name === selected_product[i].value_name) {
          dpl_product = i;
          break;
        }
      }

      if (dpl_product !== null) {
        selected_product[dpl_product].value_quantity += 1;
      } else {
        current_product.value_quantity = 1;
        selected_product.push(current_product);
      }
      renderselectedproduct();
      getTotal();
      flashRowAnimation();
    }
    function cartOnClick(index) {
  let current_product = { ...products_List[index] };
  let dpl_product = null;

  for (let i = 0; i < selected_product.length; i++) {
    if (current_product.value_name === selected_product[i].value_name) {
      dpl_product = i;
      break;
    }
  }

  if (dpl_product !== null) {
    selected_product[dpl_product].value_quantity += 1;
  } else {
    current_product.value_quantity = 1;
    selected_product.push(current_product);
  }

  renderselectedproduct();
  getTotal();
  flashRowAnimation();
}

function flashRowAnimation() {
  let rows = document.querySelectorAll("#selected_table_tr tr");
  if (rows.length > 0) {
    let lastRow = rows[rows.length - 1];
    lastRow.classList.add("row-added");

    setTimeout(() => {
      lastRow.classList.remove("row-added");
    }, 600);
  }
}

    function removeItem(index) {
      let confirmDelete = confirm("Are you sure you want to delete this item?");
      if (confirmDelete) {
        selected_product.splice(index, 1);
        renderselectedproduct();
        getTotal();
      }
    }

    function getTotal() {
      total = 0; // reset before recalculating
      selected_product.forEach((product) => {
        total += product.value_price * product.value_quantity;
      });
      document.getElementById("total_usd").innerText = total.toFixed(2) + " $";
      document.getElementById("total_khr").innerText =
        (total * 4100).toLocaleString() + " ៛";
    }

    function Cancel() {
      let confirmCancel = confirm("Are you sure you want to cancel?");
      if (confirmCancel) {
        selected_product = [];
        renderselectedproduct();
        total = 0;
        document.getElementById("total_usd").innerText = "($): 0";
        document.getElementById("total_khr").innerText = "(៛): 0";
        document.getElementById("Change_Amount").value = "";
        input_received_amount.value = "";
        document.getElementById("change_tr").style.display = "none";
        document.getElementById("change_input_th").style.display = "none";
      }
    }

    btn_Pay_Now.addEventListener("click", (e) => {
      let received_amount = input_received_amount.value;
      if (received_amount === "" || parseFloat(received_amount) < total) {
        alert("Please enter a valid amount received.");
        return;
      }
     localStorage.setItem("selected_product", JSON.stringify(selected_product));
        let width = 800, height = 800;
        let left = (window.innerWidth - width) / 2;
        let top = (window.innerHeight - height) / 2;

        window.open("invoice.html", "_blank", `width=${width},height=${height},left=${left},top=${top}`);
      });

    function getChangeaMount() {
      let received_amount = input_received_amount.value;
      let label_change_amount = document.getElementById("Change_Amount");
      let change_tr = document.getElementById("change_tr");
      let change_input_th = document.getElementById("change_input_th");

      if (received_amount === "") {
        label_change_amount.value = "";
        change_tr.style.display = "none";
        change_input_th.style.display = "none";
        return;
      }

      change_amount = parseFloat(received_amount) - parseFloat(total);
      label_change_amount.value = change_amount.toFixed(2);
      if (change_amount <= 0) {
        change_tr.style.display = "none";
        change_input_th.style.display = "none";
        return;
      }
      
      if (parseFloat(received_amount) === parseFloat(total)) {
        change_tr.style.display = "none";
        change_input_th.style.display = "none";
      } else {
        change_tr.style.display = "";
        change_input_th.style.display = "";
      }
    }
  </script>
</html>
